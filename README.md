# OptCD

OptCD is a tool for detecting unused directories generated by Java Maven plugins during a GitHub Actions workflow that runs on Linux. An unused directory is a directory whose contents are all generated during a workflow run but never accessed. 

## Setup
1. Obtain a [GitHub Personal Access Token](https://github.com/settings/tokens) that has read and write access to the repository that contains the YAML file to be optimized.
2. Obtain a free [Gemini API Key](https://aistudio.google.com/app/apikey) from Google AI Studio.
3. Install the [GitHub command line interface](https://cli.github.com) and authenticate the GitHub account with `gh auth login`. We recommend to install latest version of GitHub CLI to use our tool.
4. This tool pushes a modified version of the YAML file to be optimized to the remote repository. Switch to a convenient branch on the local repository.

## Usage
`run.sh` is the entrypoint of the tool. It takes 4 required parameters and 1 optional parameter.
```
export GITHUB_API_TOKEN=<your-github-api-token>
export GEMINI_API_KEY=<your-gemini-api-key>
./run.sh <path-to-input-yaml-file> <path-to-output-yaml-file> <owner> <repo> [output-file]
```
| Input                      | Description                                                                                                                     |
|----------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| `path-to-input-yaml-file`  | Relative or absolute path to the YAML file to be optimized, e.g., `{local_repo_root}/.github/workflows/{input_workflow}.yml`    |
| `path-to-output-yaml-file` | Relative or absolute path to the YAML file to be optimized, e.g., `{local_repo_root}/.github/workflows/{modified_workflow}.yml` |
| `owner`                    | Owner of the remote repository                                                                                                  |                                                                                                 |
| `repo`                     | Name of the remote repository                                                                                                   |
| `output-file`              | Output file path. This is an optional parameter, if not provided, the output will be written to stdout.                         |

* **Note that, input and output YAML files must reside in `.github/workflows/` folder of the local repository, and output YAML file name must be unique.**


## Example
```
git clone https://github.com/software-research/optCD-demo.git
cd optCD-demo
export GITHUB_API_TOKEN=<your-github-api-token>
export GEMINI_API_KEY=<your-gemini-api-key>
```
```
workdir/
├─ optCD-demo/
│  ├─ run.sh
│  ├─ */utils.py
├─ jsoup/
│  ├─ .github/
│  │  ├─ workflows/
│  │  │  ├─ build.yml
│  ├─ other-source-files...
```
Consider the above folder structure, an example run would be like the following (the output will be written to `output.txt`):

```
./run.sh ../jsoup/.github/workflows/build.yml ../jsoup/.github/workflows/modified-build.yml ogul1 jsoup output.txt
```

Or, if an output file name is not provided, the output will be written to standard output:

```
./run.sh ../jsoup/.github/workflows/build.yml ../jsoup/.github/workflows/modified-build.yml ogul1 jsoup
```

An example output of those commands would be like the following:

```
Unused directories and their responsible plugins in test (ubuntu-latest, 8):
╒════════════════════════════════════════════════════════╤═════════════════════════════════════════════════════════╤═════════════════════════════════╤════════════════════╕
│ Unused directory                                       │ Responsible plugin                                      │ Responsible command             │ Name of the step   │
╞════════════════════════════════════════════════════════╪═════════════════════════════════════════════════════════╪═════════════════════════════════╪════════════════════╡
│ /home/runner/work/jsoup/jsoup/target/surefire-reports/ │ maven-surefire-plugin:3.5.0:test (default-test) @ jsoup │ mvn -X verify -B --file pom.xml │ Maven Verify       │
├────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────┼─────────────────────────────────┼────────────────────┤
│ /home/runner/work/jsoup/jsoup/target/japicmp/          │ japicmp-maven-plugin:0.23.0:cmp (default) @ jsoup       │ mvn -X verify -B --file pom.xml │ Maven Verify       │
╘════════════════════════════════════════════════════════╧═════════════════════════════════════════════════════════╧═════════════════════════════════╧════════════════════╛
=====================================
Owner: ogul1
Repo: jsoup
Yaml filename: ../jsoup/.github/workflows/build.yml
Job: test (ubuntu-latest, 8)
Old commands: mvn -X verify -B --file pom.xml
Fix suggestion: mvn -X verify -B --file pom.xml -DskipTests -Djapicmp.skip=true
=====================================


Unused directories and their responsible plugins in test (ubuntu-latest, 17):
╒════════════════════════════════════════════════════════╤═════════════════════════════════════════════════════════╤═════════════════════════════════╤════════════════════╕
│ Unused directory                                       │ Responsible plugin                                      │ Responsible command             │ Name of the step   │
╞════════════════════════════════════════════════════════╪═════════════════════════════════════════════════════════╪═════════════════════════════════╪════════════════════╡
│ /home/runner/work/jsoup/jsoup/target/surefire-reports/ │ maven-surefire-plugin:3.5.0:test (default-test) @ jsoup │ mvn -X verify -B --file pom.xml │ Maven Verify       │
├────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────┼─────────────────────────────────┼────────────────────┤
│ /home/runner/work/jsoup/jsoup/target/japicmp/          │ japicmp-maven-plugin:0.23.0:cmp (default) @ jsoup       │ mvn -X verify -B --file pom.xml │ Maven Verify       │
╘════════════════════════════════════════════════════════╧═════════════════════════════════════════════════════════╧═════════════════════════════════╧════════════════════╛
=====================================
Owner: ogul1
Repo: jsoup
Yaml filename: ../jsoup/.github/workflows/build.yml
Job: test (ubuntu-latest, 17)
Old commands: mvn -X verify -B --file pom.xml
Fix suggestion: mvn -X verify -B --file pom.xml -Dmaven.test.skip=true -Djapicmp.skip=true 
=====================================


Unused directories and their responsible plugins in test (ubuntu-latest, 21):
╒════════════════════════════════════════════════════════╤═════════════════════════════════════════════════════════╤═════════════════════════════════╤════════════════════╕
│ Unused directory                                       │ Responsible plugin                                      │ Responsible command             │ Name of the step   │
╞════════════════════════════════════════════════════════╪═════════════════════════════════════════════════════════╪═════════════════════════════════╪════════════════════╡
│ /home/runner/work/jsoup/jsoup/target/surefire-reports/ │ maven-surefire-plugin:3.5.0:test (default-test) @ jsoup │ mvn -X verify -B --file pom.xml │ Maven Verify       │
├────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────┼─────────────────────────────────┼────────────────────┤
│ /home/runner/work/jsoup/jsoup/target/japicmp/          │ japicmp-maven-plugin:0.23.0:cmp (default) @ jsoup       │ mvn -X verify -B --file pom.xml │ Maven Verify       │
╘════════════════════════════════════════════════════════╧═════════════════════════════════════════════════════════╧═════════════════════════════════╧════════════════════╛
=====================================
Owner: ogul1
Repo: jsoup
Yaml filename: ../jsoup/.github/workflows/build.yml
Job: test (ubuntu-latest, 21)
Old commands: mvn -X verify -B --file pom.xml
Fix suggestion: mvn -X verify -B --file pom.xml -DskipTests -Dmaven.javadoc.skip=true
=====================================


Unused directories and their responsible plugins in test (windows-latest, 8):
Inotify log does not exist.
Unused directories and their responsible plugins in test (windows-latest, 17):
Inotify log does not exist.
Unused directories and their responsible plugins in test (windows-latest, 21):
Inotify log does not exist.
Unused directories and their responsible plugins in test (macOS-latest, 8):
Inotify log does not exist.
Unused directories and their responsible plugins in test (macOS-latest, 17):
Inotify log does not exist.
Unused directories and their responsible plugins in test (macOS-latest, 21):
Inotify log does not exist.
```

## Caveats

* We used the [inotify](https://pypi.org/project/inotify/) module of Python while watching for file changes in the filesystem. Occasionally, it may fail to add new watches to subdirectories as explained in the [Recursive Watching](https://pypi.org/project/inotify/) section in inotify's PyPI page. 
