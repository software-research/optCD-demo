# OptCD

OptCD is a tool for detecting unused directories generated by Java Maven plugins during a GitHub Actions workflow that runs on Linux. An unused directory is a directory whose contents are all generated during a workflow run but never accessed. 

## Setup
1. Obtain a [GitHub Personal Access Token](https://github.com/settings/tokens) that has read and write access to the repository that contains the YAML file to be optimized.
2. Install the [GitHub command line interface](https://cli.github.com) and authenticate the GitHub account with `gh auth login`.
3. This tool pushes a modified version of the YAML file to be optimized to the remote repository. Switch to a convenient branch on the local repository.

## Usage
`run.sh` is the entrypoint of the tool. It takes 5 required parameters and 1 optional parameter.
```
./run.sh <path-to-input-yaml-file> <path-to-output-yaml-file> <owner> <repo> <github-api-token> <output-file>
```
| Input                      | Description                                                                                                                     |
|----------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| `path-to-input-yaml-file`  | Relative or absolute path to the YAML file to be optimized, e.g., `{local_repo_root}/.github/workflows/{input_workflow}.yml`    |
| `path-to-output-yaml-file` | Relative or absolute path to the YAML file to be optimized, e.g., `{local_repo_root}/.github/workflows/{modified_workflow}.yml` |
| `owner`                    | Owner of the remote repository                                                                                                  |                                                                                                 |
| `repo`                     | Name of the remote repository                                                                                                   |
| `github-api-token`         | [GitHub Personal Access Token](https://github.com/settings/tokens) that has read and write access to the remote repository      |
| `output-file`              | Output file path. This is an optional parameter, if not provided, the output will be written to stdout.                         |

* **Note that, input and output YAML files must reside in `.github/workflows/` folder of the local repository, and output YAML file name must be unique.**


## Example
```
git clone https://github.com/software-research/optCD-demo.git
cd optCD-demo
```
```
workdir/
├─ optCD-demo/
│  ├─ run.sh
│  ├─ */utils.py
├─ JSqlParser/
│  ├─ .github/
│  │  ├─ workflows/
│  │  │  ├─ maven.yml
│  ├─ other-source-files...
```
Consider the above folder structure, an example run would be like the following (the output will be written to `output.txt`):

```
./run.sh ../JSqlParser/.github/workflows/maven.yml ../JSqlParser/.github/workflows/modified-maven.yml ogul1 JSqlParser <github-api-token> output.txt
```

Or, if an output file name is not provided, the output will be written to standard output:

```
./run.sh ../JSqlParser/.github/workflows/maven.yml ../JSqlParser/.github/workflows/modified-maven.yml ogul1 JSqlParser <github-api-token>
```

An example output of those commands would be like the following:

```
Unused directories and their responsible plugins in Java 11 building ...
╒══════════════════════════════════════════════════════════════════╤════════════════════════════════════════════════════════════════╕
│ Unused directory                                                 │ Responsible plugin                                             │
╞══════════════════════════════════════════════════════════════════╪════════════════════════════════════════════════════════════════╡
│ /home/runner/work/JSqlParser/JSqlParser/.github/workflows/       │ Not responsible by any plugin                                  │
├──────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ /home/runner/work/JSqlParser/JSqlParser/.github/ISSUE_TEMPLATE/  │ Not responsible by any plugin                                  │
├──────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ /home/runner/work/JSqlParser/JSqlParser/.git/hooks/              │ Not responsible by any plugin                                  │
├──────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ /home/runner/work/JSqlParser/JSqlParser/src/site/sphinx/_static/ │ Not responsible by any plugin                                  │
├──────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ /home/runner/work/JSqlParser/JSqlParser/target/classes/META-INF/ │ maven-bundle-plugin:5.1.8:bundle (default-bundle) @ jsqlparser │
├──────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ /home/runner/work/JSqlParser/JSqlParser/target/classes/rr/       │ Not responsible by any plugin                                  │
├──────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ /home/runner/work/JSqlParser/JSqlParser/target/site/             │ maven-pmd-plugin:3.21.2:pmd (pmd) @ jsqlparser                 │
├──────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ /home/runner/work/JSqlParser/JSqlParser/target/surefire-reports/ │ maven-surefire-plugin:3.2.5:test (default-test) @ jsqlparser   │
╘══════════════════════════════════════════════════════════════════╧════════════════════════════════════════════════════════════════╛
```

## Caveats

* We used the [inotify](https://pypi.org/project/inotify/) module of Python while watching for file changes in the filesystem. Occasionally, it may fail to add new watches to subdirectories as explained in the [Recursive Watching](https://pypi.org/project/inotify/) section in inotify's PyPI page. 